# ============================================
# FRAPPE APP AUTO-DEPLOYMENT WORKFLOW
# ============================================
# Bu fayl TEMPLATE - har bir projectga nusxa ko'chiring!
#
# USAGE:
# 1. Bu faylni nusxa ko'chiring: akfa_accounting/.github/workflows/deploy.yml
# 2. GitHub Settings ‚Üí Secrets ‚Üí Actions da quyidagilarni qo'shing:
#    - SERVER_IP
#    - SSH_PRIVATE_KEY
#    - SITE_NAME
#    - DB_PASSWORD
#    - ADMIN_PASSWORD
#    - APPS_TO_INSTALL (ixtiyoriy)
# 3. main branch ga push qiling - avtomatik deploy bo'ladi!
#
# ============================================

name: Deploy to Production

# Qachon ishga tushadi
on:
  push:
    branches:
      - main              # main branch ga push bo'lganda
  workflow_dispatch:      # Manual trigger ham mumkin

# Environment variables (GitHub Secrets dan olinadi)
env:
  FRAPPE_VERSION: "version-15"
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"
  BENCH_PATH: "/home/frappe/frappe-bench"

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # 1. CODE CHECKOUT
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full git history (for versioning)

      # ============================================
      # 2. SETUP SSH
      # ============================================
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # ============================================
      # 3. VALIDATE SECRETS
      # ============================================
      - name: Validate Configuration
        run: |
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "‚ùå ERROR: SERVER_IP secret not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SITE_NAME }}" ]; then
            echo "‚ùå ERROR: SITE_NAME secret not set!"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_PRIVATE_KEY secret not set!"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      # ============================================
      # 4. CHECK IF DEPLOYMENT EXISTS
      # ============================================
      - name: Check Deployment Status
        id: check_deploy
        run: |
          # Serverda frappe-bench bormi tekshirish
          if ssh root@${{ secrets.SERVER_IP }} "[ -d ${{ env.BENCH_PATH }} ]"; then
            echo "deployment_exists=true" >> $GITHUB_OUTPUT
            echo "üì¶ Existing deployment found - will update"
          else
            echo "deployment_exists=false" >> $GITHUB_OUTPUT
            echo "üÜï No deployment found - will do fresh install"
          fi

      # ============================================
      # 6A. FRESH DEPLOYMENT (First time)
      # ============================================
      # NOTE: This workflow is UPDATE-ONLY for cash_flow_app
      # Fresh deployment should use frappe_universal_deploy repo
      # https://github.com/Asadtop4ik/frappe_universal_deploy
      # ============================================
      - name: Fresh Deployment
        if: steps.check_deploy.outputs.deployment_exists == 'false'
        run: |
          echo "‚ùå ERROR: Fresh deployment not supported!"
          echo ""
          echo "This workflow is for UPDATING existing Frappe installations only."
          echo ""
          echo "For fresh deployment, use frappe_universal_deploy:"
          echo "  1. Clone: git clone https://github.com/Asadtop4ik/frappe_universal_deploy"
          echo "  2. Configure: cp .env.example .env"
          echo "  3. Edit .env with your settings"
          echo "  4. Deploy: sudo bash deploy/deploy.sh"
          echo ""
          echo "After fresh deployment, this workflow will auto-update the app."
          exit 1

      # ============================================
      # 6B. UPDATE EXISTING DEPLOYMENT
      # ============================================
      - name: Update Existing Deployment
        if: steps.check_deploy.outputs.deployment_exists == 'true'
        run: |
          echo "üîÑ Updating existing deployment..."
          
          # Extract app name from repository
          APP_NAME=$(basename ${{ github.repository }})
          echo "üì¶ App name: ${APP_NAME}"
          
          # ============================================
          # CRITICAL FIX: Pass SITE_NAME as variable
          # Problem: Single-quote heredoc 'FRAPPE_EOF' 
          # prevents GitHub Actions variable interpolation
          # Solution: Pass as env var to SSH session
          # ============================================
          
          ssh root@${{ secrets.SERVER_IP }} << ENDSSH
            # Extract app name from repository for this SSH session
            APP_NAME=\$(basename "${{ github.repository }}")
            
            # Pass environment variables to frappe user
            # Using double-quote heredoc to expand variables
            su - frappe << 'FRAPPE_EOF'
          # Set environment variables inside frappe shell
          export SITE_NAME="${{ secrets.SITE_NAME }}"
          export BENCH_PATH="${{ env.BENCH_PATH }}"
          export APP_NAME="\$(basename "${{ github.repository }}")"
          
          set -e
          cd \${BENCH_PATH}
          
          # Enable maintenance mode
          echo "üîß Enabling maintenance mode..."
          bench --site \${SITE_NAME} set-maintenance-mode on || true
          
          # Pull latest code - Auto-detect remote name
          echo "üì• Pulling latest code for \${APP_NAME}..."
          cd apps/\${APP_NAME}
          
          # Detect remote name (origin or upstream)
          REMOTE_NAME=\$(git remote | head -1)
          echo "üîó Using remote: \${REMOTE_NAME}"
          
          # Pull latest changes
          git fetch \${REMOTE_NAME}
          git reset --hard \${REMOTE_NAME}/${{ github.ref_name }}
          
          echo "‚úÖ Code updated to latest commit:"
          git log -1 --oneline
          
          cd \${BENCH_PATH}
          
          # Install dependencies
          echo "üì¶ Installing Python dependencies..."
          bench setup requirements || true
          
          # ============================================
          # CRITICAL: Run migrations to apply fixtures
          # ============================================
          echo "üóÑÔ∏è  Running database migrations..."
          bench --site \${SITE_NAME} migrate
          
          # Build assets
          echo "üé® Building frontend assets..."
          bench build --app \${APP_NAME}
          
          # Clear cache (ALWAYS after migrate!)
          echo "üßπ Clearing cache..."
          bench --site \${SITE_NAME} clear-cache
          bench --site \${SITE_NAME} clear-website-cache
          
          # Disable maintenance mode
          echo "‚úÖ Disabling maintenance mode..."
          bench --site \${SITE_NAME} set-maintenance-mode off
          
          echo "‚úÖ Frappe user tasks completed!"
          FRAPPE_EOF
          
          # Restart services (as root)
          echo "üîÑ Restarting services..."
          supervisorctl restart all
          systemctl reload nginx || true
          
          echo "‚úÖ Deployment updated successfully!"
          ENDSSH

      # ============================================
      # 7. HEALTH CHECK
      # ============================================
      - name: Health Check
        run: |
          echo "üè• Running health check..."
          
          # Wait for services to start
          sleep 10
          
          # Check if site is accessible
          SITE_URL="http://${{ secrets.SERVER_IP }}"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $SITE_URL || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "‚úÖ Site is accessible! (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Warning: Site returned HTTP $HTTP_CODE"
            echo "This might be normal if SSL redirect is configured"
          fi
          
          # Check via SSH
          ssh root@${{ secrets.SERVER_IP }} << 'ENDSSH'
            echo "üìä Service Status:"
            supervisorctl status | head -5
            
            echo ""
            echo "üíæ Disk Usage:"
            df -h / | tail -1
            
            echo ""
            echo "üß† Memory Usage:"
            free -h | grep Mem
          ENDSSH

      # ============================================
      # 8. SEND NOTIFICATION (Optional)
      # ============================================
      - name: Send Success Notification
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo ""
          echo "üåê Site: http://${{ secrets.SERVER_IP }}"
          echo "üì¶ App: ${{ github.repository }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          
          # Agar webhook URL bo'lsa, notification yuborish
          # curl -X POST ${{ secrets.WEBHOOK_URL }} -d "Deployment successful!"

      - name: Send Failure Notification
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs above for details"
          
          # Agar webhook URL bo'lsa, error yuborish
          # curl -X POST ${{ secrets.WEBHOOK_URL }} -d "Deployment failed!"

# ============================================
# SECURITY NOTES
# ============================================
# 1. HECH QACHON parollarni code da yozmang!
# 2. Barcha sensitive data GitHub Secrets da
# 3. SSH key ni hech qachon commit qilmang!
# 4. .env faylni .gitignore ga qo'shing
# ============================================